from typing import List
from prowler.lib.check.models import Check, CheckReportM365
from prowler.providers.common.provider import Provider
import json

class defender_malware_policy_common_attachments_filter_enabled(Check):
    """
    Check if the Common Attachment Types Filter is enabled in the Defender anti-malware policy.

    Attributes:
        metadata: Metadata associated with the check (inherited from Check).
    """

    def execute(self) -> List[CheckReportM365]:
        """
        Execute the check to verify if the Common Attachment Types Filter is enabled.

        This method checks the Defender anti-malware policy to determine if the
        Common Attachment Types Filter is enabled.

        Returns:
            List[CheckReportM365]: A list of reports containing the result of the check.
        """
        findings = []
        provider = Provider.get_global_provider()
        provider.session.execute("Import-Module ExchangeOnlineManagement -ErrorAction SilentlyContinue")
        from prowler.providers.m365.lib.powershell.m365_powershell import M365PowerShell
        exo_auth_args = M365PowerShell.get_exchange_online_auth_args(provider._credentials)
        connect_cmd = f"Connect-ExchangeOnline {exo_auth_args}"
        provider.session.execute(connect_cmd)
        result = provider.session.execute("Get-MalwareFilterPolicy -Identity Default | Select-Object EnableFileFilter | ConvertTo-Json")
        if isinstance(result, str):
            try:
                policy = json.loads(result)
            except Exception:
                policy = {}
        elif isinstance(result, dict):
            policy = result
        else:
            policy = {}
        report = CheckReportM365(
            metadata=self.metadata(),
            resource=policy,
            resource_name="Default Malware Filter Policy",
            resource_id="DefaultMalwareFilterPolicy",
            resource_location="global",
        )
        if policy.get("EnableFileFilter", False):
            report.status = "PASS"
            report.status_extended = "Common Attachment Types Filter is enabled in the Default Malware Filter Policy."
        else:
            report.status = "FAIL"
            report.status_extended = "Common Attachment Types Filter is NOT enabled in the Default Malware Filter Policy."
        findings.append(report)
        return findings
